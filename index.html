<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catálogo – Flipbook</title>
  <!-- StPageFlip CSS -->
  <link rel="stylesheet" href="https://unpkg.com/st-pageflip@2.0.7/dist/css/pageflip.css" />
  <style>
    :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#94a3b8}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{padding:1rem 1.25rem;border-bottom:1px solid #1f2937;display:flex;gap:.75rem;align-items:center;justify-content:space-between}
    header h1{font-size:1.1rem;margin:0;font-weight:600}
    main{max-width:1200px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
    .viewer{background:var(--card);border-radius:16px;padding:1rem;display:grid;gap:1rem;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    #flipbook{height:min(82vh,1000px)}
    .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;justify-content:space-between}
    .left, .right{display:flex;gap:.5rem;align-items:center}
    button{appearance:none;background:#1f2937;color:var(--text);border:1px solid #374151;border-radius:10px;padding:.6rem .9rem;font-weight:600;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:.9rem}
    .credit{color:#94a3b8;font-size:.8rem;text-align:center}
    .error{background:#7f1d1d;color:#fecaca;padding:.75rem 1rem;border-radius:10px}
    a{color:#a5b4fc}
  </style>
</head>
<body>
  <header>
    <h1>Catálogo – Flipbook (prueba sin ISSUU)</h1>
    <div class="hint">Sube tu PDF como <code>catalogo.pdf</code> o usa <code>?pdf=ruta/al.pdf</code>.</div>
  </header>

  <main>
    <section class="viewer">
      <div class="toolbar">
        <div class="left">
          <button id="prevBtn" title="Página anterior">⟵ Anterior</button>
          <button id="nextBtn" title="Página siguiente">Siguiente ⟶</button>
        </div>
        <div class="right">
          <span class="hint">Consejo: usa las flechas del teclado ◀ ▶</span>
        </div>
      </div>

      <!-- Contenedor del flipbook -->
      <div id="flipbook" aria-live="polite"></div>

      <div class="credit">Hecho con <a href="https://mozilla.github.io/pdf.js/" target="_blank" rel="noreferrer">PDF.js</a> y <a href="https://nodlik.github.io/StPageFlip/" target="_blank" rel="noreferrer">StPageFlip</a>.</div>
      <div id="errorBox" class="error" style="display:none"></div>
    </section>
  </main>

  <!-- ===================== PDF.js (versión estable v3 con worker externo) ===================== -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    // Configura la ruta del worker (misma versión) — necesario en GitHub Pages
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    }
  </script>

  <!-- StPageFlip JS -->
  <script src="https://unpkg.com/st-pageflip@2.0.7/dist/js/pageflip.min.js"></script>

  <script>
    /** Permitir ?pdf=RUTA. Si no, probar rutas comunes. **/
    const params = new URLSearchParams(location.search);
    const PDF_PARAM = params.get("pdf");
    const CANDIDATES = PDF_PARAM ? [PDF_PARAM] : [
      "catalogo.pdf",
      "./catalogo.pdf",
      "./docs/catalogo.pdf",
      "docs/catalogo.pdf",
      "./assets/catalogo.pdf",
      "assets/catalogo.pdf"
    ];

    const container = document.getElementById("flipbook");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const errorBox = document.getElementById("errorBox");

    function showError(msg){
      errorBox.textContent = msg; errorBox.style.display = "block";
    }

    async function tryFetch(url){
      try {
        // HEAD puede fallar en algunos servidores; si falla, prueba GET ligero.
        let ok = false;
        try {
          const r = await fetch(url, { method: "HEAD", cache: "no-cache" });
          ok = r.ok;
        } catch(_) {}
        if (!ok){
          const r = await fetch(url, { method: "GET", cache: "no-cache" });
          ok = r.ok;
        }
        return ok;
      } catch(_) { return false; }
    }

    async function renderPdfToImages(pdfUrl){
      if (!window.pdfjsLib) throw new Error("PDF.js no cargó correctamente.");
      const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
      const images = [];
      const scaleBase = 1.6; // calidad media/alta
      for (let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: scaleBase });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d", { alpha:false });
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        images.push(canvas.toDataURL("image/jpeg", 0.92));
      }
      return images;
    }

    function makePageElements(imageUrls){
      const frag = document.createDocumentFragment();
      imageUrls.forEach((src, idx) => {
        const page = document.createElement("div");
        page.className = "page";
        const img = document.createElement("img");
        img.loading = "lazy";
        img.alt = `Página ${idx+1}`;
        img.src = src;
        page.appendChild(img);
        frag.appendChild(page);
      });
      container.innerHTML = "";
      container.appendChild(frag);
    }

    async function init(){
      try {
        let pdfUrl = null;
        for (const cand of CANDIDATES){
          const ok = await tryFetch(cand);
          if (ok){ pdfUrl = cand; break; }
        }
        if (!pdfUrl){
          throw new Error("No encontré el archivo del catálogo. Probé: " + CANDIDATES.join(", "));
        }

        const images = await renderPdfToImages(pdfUrl);
        makePageElements(images);

        const pageFlip = new St.PageFlip(container, {
          width: 800,
          height: 1050,
          size: "stretch",
          minWidth: 320,
          minHeight: 420,
          maxShadowOpacity: 0.2,
          showCover: true,
          mobileScrollSupport: true,
          usePortrait: true,
          disableFlipByClick: false
        });
        pageFlip.loadFromHTML(document.querySelectorAll(".page"));

        prevBtn.onclick = () => pageFlip.flipPrev();
        nextBtn.onclick = () => pageFlip.flipNext();
        document.addEventListener("keydown", (e)=>{
          if (e.key === "ArrowLeft") pageFlip.flipPrev();
          if (e.key === "ArrowRight") pageFlip.flipNext();
        });

        function updateButtons(){
          const state = pageFlip.getState();
          prevBtn.disabled = state.page === 0;
          nextBtn.disabled = state.page === state.pagesCount - 1;
        }
        pageFlip.on("flip", updateButtons);
        updateButtons();
      } catch (err){
        console.error(err);
        showError(
          "Error: " + err.message +
          "\n\nSolución rápida:\n1) Asegúrate de que el PDF esté en el MISMO directorio que index.html y se llame 'catalogo.pdf'.\n   O usa '?pdf=RUTA/AL/ARCHIVO.pdf' en la URL.\n2) Si usas carpeta 'docs/', mueve ambos archivos a 'docs/' o pasa '?pdf=docs/catalogo.pdf'.\n3) Respeta mayúsculas/minúsculas en el nombre del PDF."
        );
      }
    }

    init();
  </script>
</body>
</html>
