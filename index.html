<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catálogo – Flipbook</title>
  <link rel="stylesheet" href="https://unpkg.com/st-pageflip@2.0.7/dist/css/pageflip.css" />
  <style>
    body{margin:0;background:#0f172a;color:#e5e7eb;font-family:sans-serif}
    header{padding:1rem;border-bottom:1px solid #1f2937;display:flex;justify-content:space-between;align-items:center}
    #flipbook{width:100%;height:90vh}
    button{background:#1f2937;color:#fff;border:none;border-radius:6px;padding:.5rem 1rem;cursor:pointer}
    .toolbar{padding:.5rem;display:flex;gap:.5rem}
    .error{background:#7f1d1d;color:#fecaca;padding:.5rem;margin:.5rem;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <h1>Catálogo – Flipbook</h1>
    <div>Usa flechas ◀ ▶</div>
  </header>

  <div class="toolbar">
    <button id="prevBtn">⟵ Anterior</button>
    <button id="nextBtn">Siguiente ⟶</button>
  </div>

  <div id="flipbook"></div>
  <div id="errorBox" class="error" style="display:none"></div>

  <!-- PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
  </script>

  <!-- PageFlip -->
  <script src="https://unpkg.com/st-pageflip@2.0.7/dist/js/pageflip.min.js"></script>

  <script>
    const params = new URLSearchParams(location.search);
    const PDF_PARAM = params.get("pdf");
    const candidates = PDF_PARAM ? [PDF_PARAM] : ["catalogo.pdf","docs/catalogo.pdf"];

    const container = document.getElementById("flipbook");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const errorBox = document.getElementById("errorBox");

    function showError(msg){ errorBox.style.display="block"; errorBox.textContent=msg; }

    async function findPdf(){
      for (const c of candidates){
        try{
          const r = await fetch(c,{method:"HEAD"});
          if(r.ok) return c;
        }catch(_){ }
      }
      throw new Error("No se encontró el archivo PDF en: "+candidates.join(", "));
    }

    async function renderPdf(pdfUrl){
      const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
      const images = [];
      for(let p=1;p<=pdf.numPages;p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({scale:1.5});
        const canvas=document.createElement("canvas");
        const ctx=canvas.getContext("2d");
        canvas.width=viewport.width; canvas.height=viewport.height;
        await page.render({canvasContext:ctx,viewport}).promise;
        images.push(canvas.toDataURL("image/jpeg",0.9));
      }
      return images;
    }

    async function init(){
      try{
        const pdfUrl = await findPdf();
        const images = await renderPdf(pdfUrl);
        const pageFlip = new St.PageFlip(container,{
          width:800,height:1000,size:"stretch",minWidth:300,minHeight:400,showCover:true
        });
        pageFlip.loadFromImages(images);

        prevBtn.onclick=()=>pageFlip.flipPrev();
        nextBtn.onclick=()=>pageFlip.flipNext();
        document.addEventListener("keydown",e=>{
          if(e.key==="ArrowLeft") pageFlip.flipPrev();
          if(e.key==="ArrowRight") pageFlip.flipNext();
        });
      }catch(e){
        console.error(e);
        showError("Error: "+e.message);
      }
    }
    init();
  </script>
</body>
</html>
